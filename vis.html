<head>
        <script src="bower_components/jquery/dist/jquery.min.js"></script>
        <script src="bower_components/rangeslider.js/dist/rangeslider.min.js"></script>
        <script src="bower_components/d3/d3.min.js"></script>
        <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

        <link rel="stylesheet" type="text/css" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
</head>
<body>
    <style>

    body {
        font-family: arial;
    }

    #chart {
        width: 100%;
        height:450px;
    }

    .person {
        stroke: black;
        fill: none;
        stroke-width: 1px solid;
        stroke-linecap: round;
        stroke-linejoin: round;
        shape-rendering: geometricPrecision;
    }

    #months-countdown {
        clear: left;
        font-size: 60px;
        color: lightgrey;
    }

    .country-label {
        font-size: 20px;
        fill: lightgrey;
    }
    </style>
<div class="container">
    <div class="row">
        <div class="">
            <svg id="chart"></svg>
                <div id="months-countdown"></div>
                <input
                type="range"
                min="0"                    // default 0
                max="30"                  // default 100
                step="1"                   // default 1
                value="0"                 // default min + (max-min)/2
                data-orientation="vertical" // default horizontal
            >
        </div>
</div>
<div class="row">
    <div class="col-sm-6 col-md-6 col-lg-6 col-xs-6">

            <h2>Question</h2>
                <select>
                    <option class="form-control" value="dublin applied">Dublin applied?</option>
                </select>
        </div>
    <div class="col-sm-6 col-md-6 col-lg-6 col-xs-6">
            <h2>Sort by...</h2>
            
            <div class="radio">
                <label>
                    <input type="radio" name="sortby" id="optionsRadios1" value="age" checked>
                    Age
                </label>
            </div>
            <div class="radio">
                <label>
                    <input type="radio" name="sortby" id="optionsRadios1" value="months in calais" checked>
                    Months in Calais
                </label>
            </div>
            <div class="radio">
                <label>
                    <input type="radio" name="sortby" id="optionsRadios1" value="months in france" checked>
                    Months in France
                </label>
            </div>
        </div>
        
    </div>
</div>

    <script>
    // Initialize a new plugin instance for all
    // e.g. $('input[type="range"]') elements.
    $('input[type="range"]').rangeslider({onSlide: function(position, value) { 
        console.log(position, value)
        arrivalsLayout(value); 
    }});


    var ageHeight = d3.scaleLinear() // assumes linear growth to adulthood
                .domain([12, 21])
                .range([5, 10]) // leg, torso 
                .clamp(true);

    var renderPerson = function(d) {

        // head and body
        // var rndHead = d3.randomNormal(4, 0.5)
        var rndHead = d3.randomUniform(4, 5)
        // var rndWaist = d3.randomUniform(3, 5)
        // var rndArms = d3.randomUniform()

        person = d3.select(this).attr('class', 'person')

        person.each(function(d) {
            var that = this;
            d3.xml('flags/' + d['country of origin'] + ".svg").mimeType("image/svg+xml").get(function(error, xml) {
                    if (error) throw error;
                    d3.select(that).node().appendChild(xml.documentElement);
                    d3.select(that).select('svg').attr('width', 10).attr('height', 10).attr('y', 20).style('opacity', 0.5).lower()
                });    
        })

        person.append('ellipse').attr('cx', 10).attr('cy', function(d) {
            return 30 - 2.5 * ageHeight(d.age);// - 5;
        })
            .attr('ry', function(d) { return ageHeight(d.age) / 2})
            .attr('rx', function(d) { return ageHeight(d.age) / 2});//rndHead)//.attr('stroke', 'black')

        // body line    
        person.append('path').attr('d', function(d) {
            return "M10 " + (30 - ageHeight(d.age)) + " v-" + ageHeight(d.age)
        })

        // arm and shoulders
        person.append('path').attr('d', function(d) {
            return 'M5 ' + (30 - ageHeight(d.age)) + ' q 5 -' + (2 * ageHeight(d.age) - 2) + ' 10 0'
        })

        // lower half
        person.append('path').attr('d', function(d) {
            return 'M8 30 l 2 -' + ageHeight(d.age) +' l 2 ' + ageHeight(d.age)
        })

        // dress?
        if(d.gender == 'Female') {
            person.append('path').attr('d', 'M7 25 q 3 -18 6 0 L7 25').style('fill', 'black')
        }

        

        return person;
    }

    var createPopulation = function(data) {
        population = d3.select('#chart').selectAll('person')
                    .data(data)
                    .enter()
                    .append('g')
                    
        population
            .append("svg:title")
            .text(function(d) {
                return d.gender + ', ' + Math.round(d.age) + ', from ' + d['country of origin'];
            })

        population.each(renderPerson);
    }

    var betterLayout = function(maxRow) {
        maxRow = maxRow || 20;
        d3.selectAll('.person').transition().duration(2000).ease(d3.easeCubicInOut).attr('transform', function(d, i) { 
            return 'translate(' + ((i%maxRow)*20) + ',' + (Math.floor(i / maxRow)*35) +')'
        })

        // age strips
        // d3.selectAll('.age-strip').remove(); // clear prior
        // var height = 3*ageHeight(18)
        // var y = 30 - height
        // for(i = 0; i < d3.selectAll('.person').nodes().length / maxRow; i++) {
        //     d3.select('#chart').append('rect').attr('class','age-strip')
        //     // .attr('x',0).attr('height',height).attr('width',maxRow*20).attr('y',y + 35 * i).style('fill', '#fee')//.style('stroke', '#fcc').lower()
        //     .attr('x',0).attr('height',1).attr('width',maxRow*20).attr('y',y + 35 * i).style('fill', '#f66').lower()

        // }     
    }



    var arrivalsLayout = function(months, maxRow, duration) {
        maxRow = maxRow || 30;
        duration = duration || 2000;
        var pos = 0; // for next available place
        var cPos = [0,0,0,0,0,0,0, 0, 0, 0]

        sortBy('months in france');  // months in europe?
        updateMonth(months)

        d3.selectAll('.person')
            .transition().duration(duration).ease(d3.easeCubicInOut)
            .attr('transform', function(d) {
                // console.log(d['months in france'])
                if(d['months in france'] < months) {
                    var i = 1 + countries.indexOf(d['country of origin'])
                    var x = cPos[i]++;
                    return 'translate(' + (620 + x * 10) + ', '+ (i * 30) +') scale(0.5)';// from flag or direction of origin
                } else {
                    pos++
                    return 'translate(' + ((pos%maxRow)*20) + ',' + (Math.floor(pos / maxRow)*35) +')';
                }
            })
    }

    var countdownMonth = function(month) {
        month = typeof(month) == 'undefined' ? 30 : month;
        updateMonth(month)
        month--;
        if(month == -1) return;
        setTimeout(function() { arrivalsLayout(month, 20, 1000); countdownMonth(month) }, 1000)
    }

    var showCountries = function() {
        countries.forEach(function(country) {
            var label = d3.select('#chart').append('g').attr('class', 'country-label')
                .attr('transform', 'translate(' + 600 + ',' + (15 + 30 * (1 + countries.indexOf(country))) + ')')
                // .attr('x', 600)
                // .attr('y', 15 + 30 * (1 + countries.indexOf(country)))

            label.append('text').text(country)
                .attr('text-anchor', 'end').attr('x', -5)

            d3.xml('flags/' + country + ".svg").mimeType("image/svg+xml").get(function(error, xml) {
                if (error) throw error;
                label.node().appendChild(xml.documentElement);
                label.select('svg').attr('width', 20).attr('height', 20).attr('y', -20)
            });
        })
        // d3.selectAll('.country-label > svg').attr('width', 20).attr('height', 20)
    }

    var updateMonth = function(month) {
        d3.select('#months-countdown').text(month == 0 ? 'Now' : month + (month == 1 ? ' month': ' months') + ' ago')
    }

    var sortBy = function(attr) {
        switch(attr) {
            case 'age':
                d3.selectAll('.person').sort(function(a,b){return a.age - b.age;})
            break;

            case 'gender': // non-binary?
                d3.selectAll('.person').sort(function(a,b){return a.gender == 'Female' && b.gender == 'Male' ? -1:1;})
            break;

            case 'country of origin': // non-binary?
                d3.selectAll('.person').sort(function(a,b){return a['country of origin'] < b['country of origin'] ? -1:1;})
            break;

            case 'months in europe':
                d3.selectAll('.person').sort(function(a,b){return b['months in europe'] - a['months in europe'];})
            break;

            case 'months in france':
                d3.selectAll('.person').sort(function(a,b){
                    if(b['months in france'] == a['months in france']) return b['index'] - a['index'];
                    return b['months in france'] - a['months in france']
                    ;})
            break;

        }
    } 

    var colourByResponse = function(question) {
        var palette = ['#000', '#32c0cc', '#cc3366', '#99cc66']

        var answers = d3.selectAll('.person').data().map(function(d){if (typeof d !== 'undefined') return d[question]})
        var uniqueAnswers = [...new Set(answers)].sort()

        d3.selectAll('.person *').attr('stroke', function(d) {
            if (typeof d !== 'undefined') {
                var i = uniqueAnswers.indexOf(d[question])
                return palette[i];
            }
        })
    }

    var highlightMinors = function() {

        d3.selectAll('.person *').attr('stroke', function(d) {
            if (typeof d !== 'undefined') {
                return d.age < 18 ? 'red': 'black';
            }
        })
    }

    countries = ["Ethiopia", "Ethiopia (Oromo)", "Sudan", "Afghanistan", "Tajikistan", "Eritrea", "Pakistan", "Egypt", "Other", "Palestine", "Iran", "Iraq (Kurdish)"]

    showCountries()

    population = d3.csv('6m_vis_data.csv', function(data) {
        createPopulation(data)
        betterLayout();
    })


    </script>
<!--
    NOTES
    * Individual figures emphasize these are individuals.  Small numbers make this possible.
    * Stick figures match RRDP aesthetic and convey simple vulnerability.
    * Looks better on retina display, predictably.
    * No age for a couple, scale to adult or average?
    * A few people don't give time in France or Europe.
    * Style consistently with http://refugeerights.org.uk/wp-content/uploads/2017/04/RRDP_SixMonthsOn.pdf
    * Include big percentages along with stickman partitions to questions.
    ** I.e. white / cyan on black
    ** Call outs
    ** May be able to use images to background specific question theme responses.
    ** Pie and stack charts use a lot of space for the information they provide.
    * The time is possible deceptive since is doesn't show the people who have left at the time of the survey.
    * Are some flags contentious?
    * Check age height - should hit line at 18.


    IDEAS
    * Pop out to tell story
    * Background people to show this is just a sample and does not indicate size of whole population
    * Two-level sort: e.g. gender then age
    * Need an unabiguous but unobtrusive notation for minors.
    * How to represent police violence and healthcare questions?
    * How to respresent many-response answers?
    * Lay people out on timeline for their time in france
    * Flags behind/below people, possibly simplified.
    * Sagging shoulders for length of stay
    * Come in over time from direction of origin
    * Add a little noise for variability, e.g. head size, body/leg ratio, curve alignment, etc.
    * leave body line off to match RRDP logo?  Too abstract?
    * Chord or Sankey charts would be appropriate for origin and destination but might be too unfamiliar.

    From METHODOLOGY
    We surveyed as many individuals as possible,
comparing our sample every evening against
the estimated number of individuals identified
by partner organisations operating on the
ground. Moreover, we widened our reach by
visiting one safe house, two
day centres in the area, and
one informal camp. Each of
these research locations hosts
individuals who circulate in
the Calais area, and it is our
understanding that the same
population group moves
constantly between these
research locations. This led
onto a path of so-called
snowball sampling. As a
result, selection bias could not
always be avoided, and we
were at times unable to steer
the sample and stratification
as much as we would ideally
have liked.
There is uncertainty about the
exact population size, since it
is in constant flux and there is
no official registration system.
This means it is not possible
to determine exactly how
large a sample we obtained,
and how representative
it is of the demographic
groups in the area. However,
having consulted local
aid organisations, we
estimate having surveyed
approximately 53% of
individuals in the area, not
including the 1,500 Afghan
and Kurdish residents of
the Dunkirk camp (which
burned down a few days after
completion of our research
study). We believe the country
and age groups have been
represented with relatively
good accuracy. 
    -->
</body>